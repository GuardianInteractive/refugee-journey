!function(a,b){if("object"==typeof exports&&exports)b(exports);else{var c={};b(c),a.Mustache=c}}(this,function(a){function b(a,b){return t.call(a,b)}function c(a){return!b(p,a)}function d(a){return"function"==typeof a}function e(a){return a.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function f(a){return String(a).replace(/[&<>"'\/]/g,function(a){return w[a]})}function g(a){if(!v(a)||2!==a.length)throw new Error("Invalid tags: "+a);return[new RegExp(e(a[0])+"\\s*"),new RegExp("\\s*"+e(a[1]))]}function h(b,d){function f(){if(A&&!B)for(;z.length;)delete y[z.pop()];else z=[];A=!1,B=!1}d=d||a.tags,b=b||"","string"==typeof d&&(d=d.split(o));for(var h,l,m,p,t,u,v=g(d),w=new k(b),x=[],y=[],z=[],A=!1,B=!1;!w.eos();){if(h=w.pos,m=w.scanUntil(v[0]))for(var C=0,D=m.length;D>C;++C)p=m.charAt(C),c(p)?z.push(y.length):B=!0,y.push(["text",p,h,h+1]),h+=1,"\n"===p&&f();if(!w.scan(v[0]))break;if(A=!0,l=w.scan(s)||"name",w.scan(n),"="===l?(m=w.scanUntil(q),w.scan(q),w.scanUntil(v[1])):"{"===l?(m=w.scanUntil(new RegExp("\\s*"+e("}"+d[1]))),w.scan(r),w.scanUntil(v[1]),l="&"):m=w.scanUntil(v[1]),!w.scan(v[1]))throw new Error("Unclosed tag at "+w.pos);if(t=[l,m,h,w.pos],y.push(t),"#"===l||"^"===l)x.push(t);else if("/"===l){if(u=x.pop(),!u)throw new Error('Unopened section "'+m+'" at '+h);if(u[1]!==m)throw new Error('Unclosed section "'+u[1]+'" at '+h)}else"name"===l||"{"===l||"&"===l?B=!0:"="===l&&(v=g(d=m.split(o)))}if(u=x.pop())throw new Error('Unclosed section "'+u[1]+'" at '+w.pos);return j(i(y))}function i(a){for(var b,c,d=[],e=0,f=a.length;f>e;++e)b=a[e],b&&("text"===b[0]&&c&&"text"===c[0]?(c[1]+=b[1],c[3]=b[3]):(d.push(b),c=b));return d}function j(a){for(var b,c,d=[],e=d,f=[],g=0,h=a.length;h>g;++g)switch(b=a[g],b[0]){case"#":case"^":e.push(b),f.push(b),e=b[4]=[];break;case"/":c=f.pop(),c[5]=b[2],e=f.length>0?f[f.length-1][4]:d;break;default:e.push(b)}return d}function k(a){this.string=a,this.tail=a,this.pos=0}function l(a,b){this.view=null==a?{}:a,this.cache={".":this.view},this.parent=b}function m(){this.cache={}}var n=/\s*/,o=/\s+/,p=/\S/,q=/\s*=/,r=/\s*\}/,s=/#|\^|\/|>|\{|&|=|!/,t=RegExp.prototype.test,u=Object.prototype.toString,v=Array.isArray||function(a){return"[object Array]"===u.call(a)},w={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};k.prototype.eos=function(){return""===this.tail},k.prototype.scan=function(a){var b=this.tail.match(a);if(b&&0===b.index){var c=b[0];return this.tail=this.tail.substring(c.length),this.pos+=c.length,c}return""},k.prototype.scanUntil=function(a){var b,c=this.tail.search(a);switch(c){case-1:b=this.tail,this.tail="";break;case 0:b="";break;default:b=this.tail.substring(0,c),this.tail=this.tail.substring(c)}return this.pos+=b.length,b},l.prototype.push=function(a){return new l(a,this)},l.prototype.lookup=function(a){var b;if(a in this.cache)b=this.cache[a];else{for(var c=this;c;){if(a.indexOf(".")>0){b=c.view;for(var e=a.split("."),f=0;null!=b&&f<e.length;)b=b[e[f++]]}else b=c.view[a];if(null!=b)break;c=c.parent}this.cache[a]=b}return d(b)&&(b=b.call(this.view)),b},m.prototype.clearCache=function(){this.cache={}},m.prototype.parse=function(a,b){var c=this.cache,d=c[a];return null==d&&(d=c[a]=h(a,b)),d},m.prototype.render=function(a,b,c){var d=this.parse(a),e=b instanceof l?b:new l(b);return this.renderTokens(d,e,c,a)},m.prototype.renderTokens=function(b,c,e,f){function g(a){return k.render(a,c,e)}for(var h,i,j="",k=this,l=0,m=b.length;m>l;++l)switch(h=b[l],h[0]){case"#":if(i=c.lookup(h[1]),!i)continue;if(v(i))for(var n=0,o=i.length;o>n;++n)j+=this.renderTokens(h[4],c.push(i[n]),e,f);else if("object"==typeof i||"string"==typeof i)j+=this.renderTokens(h[4],c.push(i),e,f);else if(d(i)){if("string"!=typeof f)throw new Error("Cannot use higher-order sections without the original template");i=i.call(c.view,f.slice(h[3],h[5]),g),null!=i&&(j+=i)}else j+=this.renderTokens(h[4],c,e,f);break;case"^":i=c.lookup(h[1]),(!i||v(i)&&0===i.length)&&(j+=this.renderTokens(h[4],c,e,f));break;case">":if(!e)continue;i=this.parse(d(e)?e(h[1]):e[h[1]]),null!=i&&(j+=this.renderTokens(i,c,e,f));break;case"&":i=c.lookup(h[1]),null!=i&&(j+=i);break;case"name":i=c.lookup(h[1]),null!=i&&(j+=a.escape(i));break;case"text":j+=h[1]}return j},a.name="mustache.js",a.version="0.8.0",a.tags=["{{","}}"];var x=new m;a.clearCache=function(){return x.clearCache()},a.parse=function(a,b){return x.parse(a,b)},a.render=function(a,b,c){return x.render(a,b,c)},a.to_html=function(b,c,e,f){var g=a.render(b,c,e);return d(f)?(f(g),void 0):g},a.escape=f,a.Scanner=k,a.Context=l,a.Writer=m});var JOURNEY=JOURNEY||{};JOURNEY.html={base_layout:'<div class="game_wrapper"><div class="scene_container"></div><!--<div class="control_wrapper">--><!--<p class="choice_text"></p>--><!--<div class="button_container"></div>--><!--</div>--></div><div class="testimonies"><h2>The journey</h2><div class="testimony_steps"></div><button class="testimonies_restart_btn">Start again</button><div class="share_links"><a class="twitter_share">Twitter</a><a class="facebook_share">Facebook</a></div></div>',airport:'<p>Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa.</p><p><img width="400" src="http://www.wired.com/images_blogs/autopia/images/2009/03/04/arj21.jpg" /></p><p>Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem.</p>',flight:'<h2>Flights</h2><p>Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa.</p><p><img width="400" src="http://www.liveforthedrop.com/wp-content/uploads/boat.jpg" /></p><p>Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem.</p><p>Nulla consequat massa quis enim. Donec pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim justo, rhoncus ut, imperdiet a, venenatis vitae, justo.</p><p>Nullam dictum felis eu pede mollis pretium. Integer tincidunt. Cras dapibus. Vivamus elementum semper nisi. Aenean vulputate eleifend tellus. Aenean leo ligula, porttitor eu, consequat vitae, eleifend ac, enim. Aliquam lorem ante, dapibus in, viverra quis, feugiat a,</p>',passport:'<h2>Passport copy</h2><p>Some more text here</p><p><img width="200" src="http://upload.wikimedia.org/wikipedia/commons/thumb/6/6d/Indonesian_passport_data_page.jpg/800px-Indonesian_passport_data_page.jpg" alt="passport" /></p>',start:'<h1>Hello world</h1><p>Some text goes in here.</p><video id="video" controls="" preload="none" poster="http://media.w3.org/2010/05/sintel/poster.png"><source id="mp4" src="http://media.w3.org/2010/05/sintel/trailer.mp4" type="video/mp4"><source id="webm" src="http://media.w3.org/2010/05/sintel/trailer.webm" type="video/webm"><source id="ogv" src="http://media.w3.org/2010/05/sintel/trailer.ogv" type="video/ogg"><p>Your user agent does not support the HTML5 Video element.</p></video>',view_scene:'<h2 class="scene-title">{{ title }}</h2><div class="scene-inner"><div class="testimony">{{{ testimony }}}</div><div class="scene-copy">{{{ sceneText }}}</div><div class="choices"><p class="choice_text">{{ choiceText }}</p><div class="button_container"></div></div></div>',view_testimony:'<h1>{{ heading }}</h1><div class="testimony_content">{{{ html }}}</div>',done:"true"};var JOURNEY=JOURNEY||{};JOURNEY.testimonies={airport:'<p>Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa.</p><p><img width="400" src="http://www.wired.com/images_blogs/autopia/images/2009/03/04/arj21.jpg" /></p><p>Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem.</p>',flight:'<h2>Flights</h2><p>Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa.</p><p><img width="400" src="http://www.liveforthedrop.com/wp-content/uploads/boat.jpg" /></p><p>Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem.</p><p>Nulla consequat massa quis enim. Donec pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim justo, rhoncus ut, imperdiet a, venenatis vitae, justo.</p><p>Nullam dictum felis eu pede mollis pretium. Integer tincidunt. Cras dapibus. Vivamus elementum semper nisi. Aenean vulputate eleifend tellus. Aenean leo ligula, porttitor eu, consequat vitae, eleifend ac, enim. Aliquam lorem ante, dapibus in, viverra quis, feugiat a,</p>',passport:'<h2>Passport copy</h2><p>Some more text here</p><p><img width="200" src="http://upload.wikimedia.org/wikipedia/commons/thumb/6/6d/Indonesian_passport_data_page.jpg/800px-Indonesian_passport_data_page.jpg" alt="passport" /></p>',start:'<h1>Hello world</h1><p>Some text goes in here.</p><video id="video" controls="" preload="none" poster="http://media.w3.org/2010/05/sintel/poster.png"><source id="mp4" src="http://media.w3.org/2010/05/sintel/trailer.mp4" type="video/mp4"><source id="webm" src="http://media.w3.org/2010/05/sintel/trailer.webm" type="video/webm"><source id="ogv" src="http://media.w3.org/2010/05/sintel/trailer.ogv" type="video/ogg"><p>Your user agent does not support the HTML5 Video element.</p></video>',done:"true"};var JOURNEY=JOURNEY||{};JOURNEY.data={start:{title:"Your story begins",text:"Your name is Karima. Your are a 28-year-old Sunni woman from Aleppo, and you have two children. Your husband was killed in a mortar attack three months ago. You now realise you must, for your children’s sake, get out of Syria. Now your choices begin. If you are to leave Syria, you can choose to embark on an expensive and possibly difficult journey to seek asylum in the European Union - Sweden is a popular destination - or take the shorter journey to a refugee camp in a neighbouring country ",img:"http://upload.wikimedia.org/wikipedia/commons/8/81/Waves_lajolla.jpg",testimony:"airport",choice:{text:"Do you want to try to get to Sweden or take refuge across the border in Turkey?",options:[{text:"Sweden",destination:"gotoSweden"},{text:"Turkey",destination:"gotoTurkey"}]}},gotoSweden:{title:"Seeking refuge in Sweden",text:"Great news! Sweden has said it will welcome any refugee from Syria. Unfortunately, it will only welcome them in Sweden, so first you have to cross the 3,000 miles between here and there. The intervening countries may not be as welcoming. How would you like to travel?",days:33,choice:{text:"By land or by air?",options:[{text:"Land",destination:"toSwedenbyland"},{text:"Air",destination:"toSwedenbyair"}]}},gotoTurkey:{title:"At a refugee camp in Turkey",text:"Life isn’t great in a refugee camp. In particular, schooling is limited, so every day you spend here your children’s education is on hold. But at least the daily threat of death by mortar is now far away. Your choices from here are fairly limited: you can sit it out, and hope the war ends soon. You can apply for asylum directly through one of the European countries’ agents in the camp - Germany has said it will take 10,000 refugees. Or you can go back to Syria and try your luck with another way out.",days:33,choice:{text:"What now?",options:[{text:"Apply to Germany",destination:"GermanApplication"},{text:"Sit it out",destination:"sititout"},{text:"Go back",destination:"start"}]}},GermanApplication:{title:"At a refugee camp in Turkey",text:"Life isn’t great in a refugee camp. In particular, schooling is limited, so every day you spend here your children’s education is on hold. But at least the daily threat of death by mortar is now far away. Your choices from here are fairly limited: you can sit it out, and hope the war ends soon. You can apply for asylum directly through one of the European countries’ agents in the camp - Germany has said it will take 10,000 refugees. Or you can go back to Syria and try your luck with another way out.",days:33,choice:{text:"What now?",options:[{text:"Apply to Germany",destination:"GermanApplication"},{text:"Sit it out",destination:"sititout"},{text:"Go back",destination:"start"}]}},sititout:{title:"Day after day in a Turkish refugee camp",text:"You start to feel at home in the camp eventually. You meet your neighbours. One of them has a Palestinian grandfather who knows people from his childhood who went to a refugee camp in Lebanon in 1948 and are still there. You wonder if your children will spend their entire lives in this camp. Your story is not over, but nor is it continuing.",success:!1,end:!0},toSwedenbyland:{title:"Overland out of Syria",text:"Your first step is to find a people smuggler who’s willing to get you out of Syria. With your resources, and contacts, the best you can do is find someone who’ll get you as far as Istanbul. The good news is that, although the journey is long and hard, in an airless container, you do finally arrive on the outskirts of Istanbul. Your next challenge is how to continue. In the Turkish capital you find people who will offer to get you into Greece or into Bulgaria. From there you’ll be inside the EU and able to travel relatively freely all the way to Sweden. Which to choose?",days:33,choice:{text:"Bulgaria or Greece",options:[{text:"Bulgaria",destination:"toBulgaria"},{text:"Greece",destination:"toGreece"}]}},toBulgaria:{title:"title",text:"A policeman boards your minibus as you cross into Bulgaria near Lesovo. He drags you and others off the bus. After a long wait, immigration officials take your fingerprints and name. Then another minibus arrives and you find yourself bundled onboard. When the doors open again your find yourself in the Turkish city of Edirne. This is illegal, but you have limited recourse to challenge it: you’re unlikely now ever to get into Europe as an official asylum seeker. ",success:!1,end:!0},toGreece:{title:"title",text:"You make it into Greece, and bypass Thessaloniki on your way to Athens, from where you hope it will be easier to join an international bus service to  Poland. Unfortunately, Athens is also the heartland of Golden Dawn, the far right party linked to ugly attacks on migrants.",success:!1,end:!0},toSwedenbyair:{title:"Need a passport",text:"The first problem you’ll encounter is that it is now impossible to get a visa, for pretty much anywhere, from Syria. So you’ll need a false passport, ideally for a country which doesn’t require a visa to enter Sweden. Assuming you lack the scruples and posess the means for this approach, and get onto a plane, you face a choice at the airport in Sweden. Do you approach the first official you see, before leaving the airport, and admit that your papers are invalid, or do you try to get out into the city before continuing your quest for asylum?",testimony:"passport",days:33,choice:{text:"Come clean or keep quiet?",options:[{text:"Come clean",destination:"comeclean"},{text:"Keep quiet",destination:"keepquiet"}]}},comeclean:{title:"Owning up to false documents in Stockholm Airport",text:"Safe at last! International treaties guarantee you asylum if you approach the receiving authority at the earliest opportunity. What you had to do to get here is irrelevant. Enjoy your new life in Sweden.",success:!0,end:!0},keepquiet:{title:"Through passport control in Stockholm",text:"After a couple of days finding your feet in Sweden you decide to seek asylum officially. The bad news is that by knowingly entering the country using false documents you have committed a crime. The good news is that the Swedes are willing to overlook it, and grant you asylum. Who knows if a change in the political weather will mean that the next Syrian to make this mistake won’t be repatriated. ",success:!0,end:!0},cheapPassport:{title:"Buy cheap passport",text:"You purchase a cheap passport.",days:6,cost:300,item:"cheapPassport",choice:{options:[{text:"Continue on",destination:"arriveInGreece"}]}},expensivePassport:{title:"Buy expensive passport",text:"You purchase an expensive passport.",days:9,cost:800,item:"expensivePassport",choice:{options:[{text:"Continue on",destination:"arriveInGreece"}]}},travelByAir:{title:"Travelling by air",text:"You need a false passport.",asset:"airport",days:8,cost:500,choice:{text:"Do you buy a false passort?",options:[{text:"Buy a false passport",destination:"buyPassport"},{text:"Try without a passport",destination:"arriveInGreece"}]}},arriveInGreece:{title:"Arrive in Greece",text:"You arrive in a Greece airport.",days:33,choice:{text:"Airport security want to see your passport.",options:[{text:"Show passport",destination:"showPassport"},{text:"Fess up",destination:"noPassport"}]}},showPassport:{title:"Show passport",text:"You show security your passport",choice:{options:[{text:"Hand over passport",destination:"logic_passport"}]}},logic_passport:{title:"passport logic check",logic:!0,requireItem:"passport",outcomes:{good:{destination:"allowedIn"},bad:{destination:"turnedAway"}}},turnedAway:{title:"Beaten up",text:"You get beaten up",success:!1,end:!0},allowedIn:{title:"You get in",text:"Great! Welcome to your new life",success:!0,end:!0},scene4:{title:"Into Greece",text:"You get beaten up",success:!1,end:!0},scene5:{title:"Into Bulgaria",text:"You get turned back",end:!0},scene6:{title:"You fess up",text:"Great! Welcome to your new life",success:!0,end:!0},scene7:{title:"You keep schtum",text:"Sorry. Back you go",success:!1,choice:{options:[{text:"Next",destination:"scene3"}]}}};var JOURNEY=JOURNEY||{};JOURNEY.Game=function(a){"use strict";function b(){return{scenes:[],items:[],success:null}}function c(){C.innerHTML=JOURNEY.html.base_layout,y=$(".game_wrapper",C),s=$(".scene_container",C),t=$(".scene_content",C),u=$(".scene_text",C),w=$(".choice_text",C),B=$(".button_container",C),x=$(".debug_output",C),A=$(".testimonies",C),z=$(".testimony_steps"),$(".testimonies_restart_btn").on("click",d),v=document.createElement("button"),v.classList.add("choice_btn"),$(".twitter_share").on("click",p),$(".facebook_share").on("click",q)}function d(){F=new b,D="start",y.show(),A.hide(),e()}function e(){var a=JOURNEY.data[D];return"start"===D&&(F=new b),a.logic?("passport"===a.requireItem&&(D=!0===g()?a.outcomes.good.destination:a.outcomes.bad.destination),e()):(y.css("background-image",a.img?"url("+a.img+")":""),B.empty(),s.html(Mustache.render(JOURNEY.html.view_scene,{title:a.title,testimony:JOURNEY.testimonies[a.testimony],sceneText:a.text,choiceText:a.choice?a.choice.text:""})),B=$(".button_container",s),a.choice?(a.choice.text&&w.text("> "+a.choice.text),i(a.choice.options)):a.end===!0&&(F.success=a.success,E.push(F),j("Start again","start"),f(F.scenes)),a.item&&F.items.push(a.item),h(),void 0)}function f(a){z.empty(),y.hide(),A.show(),a.forEach(function(a){if(JOURNEY.data.hasOwnProperty(a)){var b={heading:JOURNEY.data[a].title,html:""};JOURNEY.data[a].hasOwnProperty("testimony")&&(b.html+=JOURNEY.testimonies[JOURNEY.data[a].testimony]);var c=Mustache.render(JOURNEY.html.view_testimony,b);z.append(c)}})}function g(){return-1!==F.items.indexOf("cheepPassport")?Math.random()<.5:-1!==F.items.indexOf("expensivePassport")?Math.random()<.9:!1}function h(){F.scenes.push(D)}function i(a){a.map(function(a){j(a.text,a.destination)})}function j(a,b){var c=$("<button></button>").text(a);c.on("click",function(){k(b)}),B.append(c)}function k(a){D=a,e()}function l(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null==c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function m(a){return a.every(function(a){return JOURNEY.data.hasOwnProperty(a)})}function n(){var a="http://example.com/share/example/";return F.scenes.length>0&&(a+="?journey="+encodeURIComponent(F.scenes.join(","))),a}function o(a,b){var c=a;for(var d in b)b.hasOwnProperty(d)&&(c+=d+"="+b[d]+"&");window.open(c,"Share","width=640,height=500,resizable,scrollbars=yes,status=1")}function p(a){a.preventDefault();var b={related:"guardian",text:"Refugee journey tweet text",via:"guardian",url:n(),hashtags:"TEST,HASH,TAGS"};o("https://twitter.com/share?",b)}function q(a){a.preventDefault();var b={"p[title]":"PAGE TITLE","p[summary]":"Refugee journey SUMMARY TEXT","p[url]":n(),"p[images][0]":"http://placehold.it/960x500"};o("http://www.facebook.com/sharer.php?s=100&",b)}function r(){c();var a=l("journey").split(",");a.length>0&&m(a)?f(a):d()}var s,t,u,v,w,x,y,z,A,B,C=a,D="start",E=[],F=new b;return r(),this};